flowchart TB
    Start([System Start]) --> InitSlave[Arduino Secundario: Initialize I2C Slave 0x08]
    Start --> InitMaster[Arduino Principal: Initialize I2C Master]
    Start --> InitPython[Python: Connect to Serial COM3]
    
    InitSlave --> ReadSensor[Arduino Secundario: Read HC-SR04 Sensor]
    ReadSensor --> StoreDist[Store distance value in memory]
    StoreDist --> WaitRequest{Wait for I2C request}
    
    InitMaster --> Wait15s{Wait 15 seconds interval?}
    Wait15s -->|Yes| StateReadI2C[STATE: READ_I2C<br/>Request data via I2C]
    Wait15s -->|No| Wait15s
    
    WaitRequest -->|Master requests| SendI2C[Send distance via I2C]
    SendI2C --> ReadSensor
    
    StateReadI2C --> ReceiveI2C[Receive distance from slave]
    ReceiveI2C --> ValidData{Valid data?}
    ValidData -->|No| ErrorI2C[Set distance = 0]
    ValidData -->|Yes| StateCheckAlert[STATE: CHECK_ALERT<br/>Evaluate distance threshold]
    ErrorI2C --> StateCheckAlert
    
    StateCheckAlert --> Threshold{Distance < 20 cm?}
    Threshold -->|Yes| LEDOn[Turn LED ON<br/>Print ALERT]
    Threshold -->|No| LEDOff[Turn LED OFF]
    
    LEDOn --> StateSendSerial[STATE: SEND_SERIAL<br/>Format: DISTANCE:value]
    LEDOff --> StateSendSerial
    
    StateSendSerial --> SendSerial[Send via Serial to Python]
    SendSerial --> StateIdle[STATE: IDLE<br/>Wait for next cycle]
    StateIdle --> Wait15s
    
    InitPython --> ListenSerial{Listen Serial Port}
    ListenSerial --> ReceiveData{Data available?}
    ReceiveData -->|No| ListenSerial
    ReceiveData -->|Yes| ParseData[Parse line from Arduino]
    
    ParseData --> CheckFormat{Format: DISTANCE:value?}
    CheckFormat -->|No| PrintDebug[Print debug message]
    CheckFormat -->|Yes| ExtractDist[Extract distance value]
    PrintDebug --> ListenSerial
    
    ExtractDist --> PreparePayload[Prepare ThingSpeak payload<br/>API Key + Field1]
    PreparePayload --> SendHTTP[Send HTTP GET to ThingSpeak API]
    
    SendHTTP --> CheckResponse{HTTP 200 OK?}
    CheckResponse -->|No| ErrorHTTP[Print error message]
    CheckResponse -->|Yes| CheckEntry{Entry ID != 0?}
    ErrorHTTP --> ListenSerial
    
    CheckEntry -->|No| RateLimit[ThingSpeak rate limit]
    CheckEntry -->|Yes| Success[âœ“ Data published successfully<br/>Print Entry ID and URL]
    RateLimit --> ListenSerial
    Success --> ListenSerial
    
    style InitSlave fill:#e1f5ff
    style InitMaster fill:#fff4e1
    style InitPython fill:#e8f5e9
    style ReadSensor fill:#e1f5ff
    style StateReadI2C fill:#fff4e1
    style StateCheckAlert fill:#fff4e1
    style StateSendSerial fill:#fff4e1
    style StateIdle fill:#fff4e1
    style LEDOn fill:#ffebee
    style Success fill:#c8e6c9
    style ErrorI2C fill:#ffcdd2
    style ErrorHTTP fill:#ffcdd2
    style RateLimit fill:#fff9c4
